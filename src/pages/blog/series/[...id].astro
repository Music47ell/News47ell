---
import { getCollection } from 'astro:content'
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

import Link from '@/components/Link.astro'
import ViewsCounter from '@/components/ViewsCounter.astro'
import Newsletter from '@/components/Newsletter.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'
import siteMetadata from '@/data/siteMetadata'

export async function getStaticPaths() {
	const allSeries = (await getCollection('series')) as CollectionEntry[]
	const allPosts = (await getCollection('blog')) as CollectionEntry[]

	const postsWithSeries = allPosts.map((post) => {
		const series = allSeries.find((series) => series.slug === post.data.series)
		return {
			...post,
			series,
		}
	})

	return postsWithSeries.map((post) => ({
		params: {
			id: post.slug,
		},
	}))
}

const { id } = Astro.params

const seriesTitle = (await getCollection('series')).find((series) => series.slug === id).data.title
const posts = (await getCollection('blog'))
	.filter((post) => post.data.series_id === id)
	.sort((a, b) => a.data.published_at.getTime() - b.data.published_at.getTime())
---

<BaseLayout title={seriesTitle} description={siteMetadata.description} type="website">
	<Newsletter />
	<main
		class="divide-y divide-purple-400 overflow-hidden rounded-xl border border-yellow-500 bg-stone-900"
	>
		{
			posts.map((post) => (
				<div class="flex no-underline items-baseline justify-between gap-x-4 p-4 max-sm:flex-col">
					<Link href={`/blog/${post.slug}`}>
						<p class="font-medium">{post.data.title}</p>
					</Link>
					<ViewsCounter slug={post.slug} trackViews={false} />
				</div>
			))
		}
	</main>
</BaseLayout>
